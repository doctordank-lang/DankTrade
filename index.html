<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockStream Terminal v4.0 (Monte Carlo)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-dark: #0b0e11;
            --panel-dark: #151a21;
            --border-color: #2d3748;
            --accent-color: #10b981;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0b0e11; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Table Styles */
        .terminal-table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            color: #94a3b8;
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .terminal-table th:first-child { text-align: left; }
        
        .terminal-table td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid #1e293b;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            transition: background-color 0.3s;
            white-space: nowrap;
            cursor: pointer;
        }
        .terminal-table td:first-child { text-align: left; }
        
        .terminal-row:hover { background-color: #1e293b; }
        .terminal-row.selected { background-color: rgba(16, 185, 129, 0.1); border-left: 2px solid #10b981; }

        /* Ticker Tape */
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background-color: #0f172a;
            border-bottom: 1px solid #1e293b;
            height: 32px;
            display: flex;
            align-items: center;
        }
        .ticker { display: flex; animation: ticker 60s linear infinite; white-space: nowrap; }
        .ticker-item { padding: 0 2rem; font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; display: flex; align-items: center; gap: 0.5rem; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* Flash Animations */
        @keyframes flash-green-bg { 0% { background-color: rgba(16, 185, 129, 0.2); } 100% { background-color: transparent; } }
        @keyframes flash-red-bg { 0% { background-color: rgba(239, 68, 68, 0.2); } 100% { background-color: transparent; } }
        .flash-up { animation: flash-green-bg 1s ease-out; }
        .flash-down { animation: flash-red-bg 1s ease-out; }

        /* Chat & Toast */
        .chat-msg-user { background-color: #1e293b; color: #fff; border-radius: 12px 12px 0 12px; padding: 10px 14px; margin-left: auto; max-width: 85%; font-size: 0.85rem; }
        .chat-msg-ai { background-color: rgba(16, 185, 129, 0.1); color: #e2e8f0; border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px 12px 12px 0; padding: 10px 14px; margin-right: auto; max-width: 90%; font-size: 0.85rem; }
        
        .toast { 
            position: fixed; bottom: 20px; right: 20px; 
            background: #1e293b; border: 1px solid #334155; color: white; 
            padding: 12px 20px; border-radius: 8px; font-size: 0.9rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1000;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { border-left: 4px solid #f43f5e; }
        .toast.success { border-left: 4px solid #10b981; }

        /* Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #10b981; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden text-slate-300 relative">

    <!-- Toasts -->
    <div id="toastContainer"></div>

    <!-- Top Ticker -->
    <div class="ticker-wrap">
        <div class="ticker" id="tickerTape"></div>
    </div>

    <!-- Navbar -->
    <nav class="border-b border-slate-800 bg-[#0f172a] z-40 h-14 flex-shrink-0">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 h-full">
            <div class="flex justify-between items-center h-full">
                <div class="flex items-center gap-3">
                    <div class="bg-emerald-500/10 p-1.5 rounded-md border border-emerald-500/20">
                        <i data-lucide="activity" class="text-emerald-500 h-5 w-5"></i>
                    </div>
                    <span class="text-lg font-bold text-slate-100 tracking-tight font-mono">STOCK<span class="text-emerald-500">STREAM</span></span>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Status Pill -->
                    <div id="connectionStatus" class="hidden md:flex text-[10px] font-bold tracking-wider text-amber-500 bg-amber-500/10 px-3 py-1.5 rounded border border-amber-500/20 items-center gap-2 uppercase">
                        <div class="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></div>
                        SIMULATION
                    </div>

                    <div class="h-6 w-px bg-slate-800 mx-2"></div>

                    <button onclick="toggleChat()" class="group flex items-center gap-2 text-xs font-medium text-slate-400 hover:text-white transition-colors bg-slate-800/50 hover:bg-slate-700 px-3 py-1.5 rounded border border-slate-700">
                        <i data-lucide="message-square" class="w-4 h-4 text-emerald-500"></i>
                        <span class="hidden sm:inline">Analyst</span>
                    </button>
                    
                    <button onclick="togglePanel('settingsModal')" class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors" title="Settings">
                        <i data-lucide="settings" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex flex-grow overflow-hidden relative">
        
        <!-- Sidebar -->
        <aside class="w-64 border-r border-slate-800 bg-[#11161d] hidden lg:flex flex-col z-20">
            <div class="p-4 border-b border-slate-800">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Watchlist</h2>
                <form id="addStockFormSidebar" class="flex gap-2">
                    <input type="text" id="sidebarSymbolInput" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-1.5 text-xs text-white focus:border-emerald-500 outline-none font-mono uppercase" placeholder="SYMBOL" maxlength="5">
                    <button type="submit" class="bg-slate-800 hover:bg-slate-700 text-emerald-500 border border-slate-700 rounded px-2 flex items-center justify-center">
                        <i data-lucide="plus" class="w-3 h-3"></i>
                    </button>
                </form>
            </div>
            <div class="flex-grow overflow-y-auto p-2 space-y-1" id="miniWatchlist"></div>
            
            <!-- News Feed Section in Sidebar -->
            <div class="flex-shrink-0 border-t border-slate-800 h-1/3 flex flex-col bg-[#0f172a]">
                <div class="px-3 py-2 border-b border-slate-800 bg-[#151a21]">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Live News</span>
                </div>
                <div id="newsFeed" class="overflow-y-auto p-3 space-y-3 text-xs text-slate-400">
                    <!-- News Items -->
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow flex flex-col bg-[#0b0e11] overflow-hidden relative w-full">
            
            <!-- Top Section: Chart & Toolbar -->
            <div class="h-1/2 flex flex-col border-b border-slate-800">
                <div class="px-6 py-3 flex justify-between items-center border-b border-slate-800/50 bg-[#151a21]">
                    <div class="flex items-center gap-4">
                        <h2 id="chartTitle" class="text-lg font-bold text-white font-mono">MARKET OVERVIEW</h2>
                        <span id="chartPrice" class="text-xl font-mono text-emerald-400"></span>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="runMonteCarlo()" class="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-medium rounded border border-indigo-500/50 transition-colors shadow-lg shadow-indigo-900/20">
                            <i data-lucide="dices" class="w-3 h-3"></i> Monte Carlo
                        </button>
                         <button onclick="togglePanel('technicalsPanel')" class="flex items-center gap-2 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-medium rounded border border-slate-700 transition-colors">
                            <i data-lucide="sliders" class="w-3 h-3"></i> Sim Controls
                        </button>
                    </div>
                </div>
                <div class="flex-grow relative p-4 bg-[#0b0e11]">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- Bottom Section: Data Grid -->
            <div class="h-1/2 flex flex-col overflow-hidden">
                 <div class="px-6 py-2 bg-[#151a21] border-b border-slate-800 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-500 uppercase">Real-Time Quotes</span>
                    <div class="flex items-center gap-2 text-xs font-mono text-slate-500">
                         <span><span id="assetCount" class="text-white">0</span> ASSETS</span>
                         <span>•</span>
                         <span id="clock" class="text-emerald-500">--:--:--</span>
                    </div>
                </div>
                <div class="flex-grow overflow-x-auto overflow-y-auto">
                    <table class="w-full terminal-table border-collapse">
                        <thead class="bg-[#11161d] sticky top-0 z-10 shadow-md">
                            <tr>
                                <th>Symbol</th>
                                <th>Price</th>
                                <th>Change</th>
                                <th>%</th>
                                <th>Day High/Low</th>
                                <th>Vol</th>
                                <th>Signal</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody" class="bg-[#0b0e11]"></tbody>
                    </table>
                    <div id="emptyState" class="hidden flex flex-col items-center justify-center h-32 text-center">
                        <i data-lucide="bar-chart-2" class="h-8 w-8 text-slate-700 mb-2"></i>
                        <p class="text-slate-500 font-mono text-xs">NO DATA</p>
                    </div>
                </div>
            </div>
            
            <!-- Technicals Panel (Slide Down) -->
            <div id="technicalsPanel" class="absolute top-0 left-0 right-0 bg-[#1a202c] border-b border-slate-700 shadow-2xl transform -translate-y-full transition-transform duration-300 z-30 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-emerald-400 uppercase tracking-widest">Simulation Mechanics</h3>
                    <button onclick="togglePanel('technicalsPanel')" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <div class="flex justify-between text-xs font-mono text-slate-400 mb-2"><span>VOLATILITY</span><span id="volValue" class="text-emerald-400">Low</span></div>
                        <input type="range" id="volSlider" min="1" max="10" value="2" class="w-full" oninput="updateSimParams()">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs font-mono text-slate-400 mb-2"><span>TREND</span><span id="trendValue" class="text-white">Neutral</span></div>
                        <input type="range" id="trendSlider" min="-5" max="5" value="0" step="0.5" class="w-full" oninput="updateSimParams()">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs font-mono text-slate-400 mb-2"><span>SPEED</span><span id="speedValue" class="text-emerald-400">2000ms</span></div>
                        <input type="range" id="speedSlider" min="100" max="5000" value="2000" step="100" class="w-full" oninput="updateSpeed()">
                    </div>
                </div>
            </div>

        </main>

        <!-- Chat Panel (Slide In) -->
        <div id="chatPanel" class="absolute inset-y-0 right-0 w-full sm:w-96 bg-[#151a21] border-l border-slate-700 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
            <div class="px-4 py-4 border-b border-slate-700 flex justify-between items-center bg-[#1a202c]">
                <div class="flex items-center gap-2 text-emerald-400">
                    <i data-lucide="bot" class="h-5 w-5"></i>
                    <h3 class="font-bold text-white tracking-wider font-mono uppercase">AI Analyst</h3>
                </div>
                <button onclick="toggleChat()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            <div id="chatHistory" class="flex-grow overflow-y-auto p-4 space-y-4 custom-scrollbar bg-[#0f172a]">
                <div class="chat-msg-ai">System Online. Connected to live market feed. How can I assist with your portfolio?</div>
            </div>
            <div class="p-4 border-t border-slate-700 bg-[#1a202c]">
                <form id="chatForm" class="relative">
                    <input type="text" id="chatInput" class="w-full bg-[#0b0e11] border border-slate-700 rounded-lg pl-4 pr-12 py-3 text-xs text-white focus:border-emerald-500 outline-none font-mono" placeholder="Ask analysis..." autocomplete="off">
                    <button type="submit" class="absolute right-2 top-2 p-1.5 text-emerald-500 hover:text-white rounded transition-colors">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Monte Carlo Modal -->
    <div id="mcModal" class="fixed inset-0 z-[100] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#151a21] border border-slate-700 rounded-lg shadow-2xl max-w-3xl w-full p-6 flex flex-col h-[80vh]">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-500/10 p-2 rounded">
                        <i data-lucide="dices" class="w-5 h-5 text-indigo-500"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-white font-mono text-lg">MONTE CARLO SIMULATION</h3>
                        <p class="text-xs text-slate-500">1,000 Iterations • 30 Day Forecast • <span id="mcStockName" class="text-indigo-400"></span></p>
                    </div>
                </div>
                <button onclick="togglePanel('mcModal')" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex-grow bg-[#0b0e11] border border-slate-800 rounded p-4 mb-4 relative">
                <canvas id="mcChart"></canvas>
            </div>

            <div class="grid grid-cols-3 gap-4 text-center">
                <div class="bg-[#1a202c] p-3 rounded border border-slate-800">
                    <p class="text-[10px] text-slate-500 uppercase">Worst Case (10%)</p>
                    <p id="mcWorst" class="text-rose-500 font-mono font-bold text-lg">--</p>
                </div>
                <div class="bg-[#1a202c] p-3 rounded border border-slate-800">
                    <p class="text-[10px] text-slate-500 uppercase">Average Outcome</p>
                    <p id="mcAvg" class="text-white font-mono font-bold text-lg">--</p>
                </div>
                <div class="bg-[#1a202c] p-3 rounded border border-slate-800">
                    <p class="text-[10px] text-slate-500 uppercase">Best Case (90%)</p>
                    <p id="mcBest" class="text-emerald-500 font-mono font-bold text-lg">--</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-[100] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#151a21] border border-slate-700 rounded-lg shadow-2xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-white font-mono uppercase">System Configuration</h3>
                <button onclick="togglePanel('settingsModal')" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-emerald-500 uppercase mb-2">Financial Modeling Prep (FMP) Key</label>
                    <input type="password" id="fmpKeyInput" class="w-full bg-[#0b0e11] border border-slate-700 rounded px-3 py-2 text-white text-xs font-mono focus:border-emerald-500 outline-none" placeholder="Leave empty for SIMULATION mode">
                    <p class="text-[10px] text-slate-500 mt-1">Required for Real-Time Data & News.</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-blue-500 uppercase mb-2">Gemini API Key (Optional)</label>
                    <input type="password" id="geminiKeyInput" class="w-full bg-[#0b0e11] border border-slate-700 rounded px-3 py-2 text-white text-xs font-mono focus:border-blue-500 outline-none" placeholder="Use if default AI connection fails">
                    <p class="text-[10px] text-slate-500 mt-1">Overrides system key. Useful for local usage.</p>
                </div>
                <button onclick="saveSettings()" class="w-full py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold uppercase tracking-wider rounded transition-colors shadow-lg shadow-emerald-900/20">Save & Reload System</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global Configuration ---
        const systemApiKey = ""; 
        let userGeminiKey = localStorage.getItem('gemini_api_key') || '';
        let fmpApiKey = localStorage.getItem('fmp_api_key') || '';
        
        // Simulation Params
        let simVolatility = 0.002;
        let simTrend = 0;
        let tickSpeed = 2000;
        let updateInterval;
        let chartInstance = null;
        let mcChartInstance = null;
        let selectedStockSymbol = null;

        // Fallback Responses for Local AI Mode
        const localAiResponses = [
            "Market volatility suggests a defensive position. Consider hedging with sector ETFs.",
            "Volume analysis indicates strong institutional support at current levels.",
            "RSI divergence detected. A short-term trend reversal is possible.",
            "Based on current price action, the stock is testing key resistance levels.",
            "Sector rotation is favoring tech and healthcare today. Adjust exposure accordingly.",
            "Implied volatility is rising. Option premiums are expensive.",
            "Momentum indicators are bullish, but watch for overbought conditions."
        ];

        // Initial Data (Saved in LocalStorage)
        const defaultStocks = [
            { symbol: 'AAPL', price: 175.43, change: 1.25, changePercent: 0.72, volume: 54000000, dayHigh: 176.1, dayLow: 174.8, history: [] },
            { symbol: 'NVDA', price: 460.18, change: 8.45, changePercent: 1.87, volume: 45000000, dayHigh: 462.3, dayLow: 455.1, history: [] },
            { symbol: 'TSLA', price: 245.67, change: 5.32, changePercent: 2.21, volume: 105000000, dayHigh: 248.0, dayLow: 241.5, history: [] }
        ];
        
        let stocks = JSON.parse(localStorage.getItem('saved_stocks')) || defaultStocks;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            document.getElementById('fmpKeyInput').value = fmpApiKey;
            document.getElementById('geminiKeyInput').value = userGeminiKey;

            updateModeUI();
            startClock();
            initChart();
            renderTable();
            renderSidebar();
            renderNews(); 
            
            // Validate Stock History (Fix for broken local storage)
            stocks.forEach(s => {
                if(!s.history || !Array.isArray(s.history)) {
                    s.history = [];
                    for(let i=0; i<20; i++) addToHistory(s, s.price);
                }
            });

            startEngine();
            
            // Listeners
            document.getElementById('addStockFormSidebar').addEventListener('submit', (e) => {
                e.preventDefault();
                addStock(document.getElementById('sidebarSymbolInput').value);
                document.getElementById('sidebarSymbolInput').value = '';
            });

            document.getElementById('chatForm').addEventListener('submit', (e) => {
                e.preventDefault();
                handleChatSubmit();
            });

            if(stocks.length > 0) selectStock(stocks[0].symbol);
        });

        // --- Core Engine ---
        function startEngine() {
            if (updateInterval) clearInterval(updateInterval);
            const isRealMode = !!fmpApiKey;
            const interval = isRealMode ? 15000 : tickSpeed; 
            
            updatePrices(); 
            updateInterval = setInterval(updatePrices, interval);
        }

        async function updatePrices() {
            if (fmpApiKey) {
                await fetchRealPrices();
            } else {
                simulatePrices();
            }
            saveState();
        }

        function simulatePrices() {
            stocks.forEach(stock => {
                const randomMove = (Math.random() - 0.5) * simVolatility * stock.price;
                const trendMove = (simTrend / 1000) * stock.price;
                const move = randomMove + trendMove;
                
                const oldPrice = stock.price;
                stock.price += move;
                stock.change += move;
                stock.changePercent = (stock.change / (stock.price - stock.change)) * 100;
                
                if(stock.price > stock.dayHigh) stock.dayHigh = stock.price;
                if(stock.price < stock.dayLow) stock.dayLow = stock.price;
                stock.volume += Math.floor(Math.random() * 10000);
                
                addToHistory(stock, stock.price);
                updateRowUI(stock, oldPrice);
            });
            
            updateTicker();
            if(selectedStockSymbol) updateChartData();
            if(Math.random() > 0.95) generateSimNews();
        }

        async function fetchRealPrices() {
            const symbols = stocks.map(s => s.symbol).join(',');
            if(!symbols) return;
            
            try {
                const res = await fetch(`https://financialmodelingprep.com/api/v3/quote/${symbols}?apikey=${fmpApiKey}`);
                if(!res.ok) throw new Error('API Error');
                const data = await res.json();
                
                if(data.length === 0) throw new Error('Invalid Key or Limit');

                data.forEach(real => {
                    const local = stocks.find(s => s.symbol === real.symbol);
                    if(local) {
                        const old = local.price;
                        local.price = real.price;
                        local.change = real.change;
                        local.changePercent = real.changesPercentage;
                        local.dayHigh = real.dayHigh;
                        local.dayLow = real.dayLow;
                        local.volume = real.volume;
                        
                        addToHistory(local, local.price);
                        updateRowUI(local, old);
                    }
                });
                
                updateTicker();
                if(selectedStockSymbol) updateChartData();
                fetchRealNews(); 
                
            } catch(e) {
                showToast("Connection Lost. Reverting to SIM.", "error");
                fmpApiKey = ""; 
                updateModeUI();
                startEngine(); 
            }
        }

        // --- Monte Carlo Simulation ---
        function runMonteCarlo() {
            const stock = stocks.find(s => s.symbol === selectedStockSymbol);
            if(!stock) return;

            document.getElementById('mcModal').classList.remove('hidden');
            document.getElementById('mcStockName').innerText = stock.symbol;

            // 1. Calculate Historical Volatility (Simple Std Dev of returns)
            let returns = [];
            for(let i = 1; i < stock.history.length; i++) {
                returns.push(Math.log(stock.history[i].price / stock.history[i-1].price));
            }
            
            // Default to plausible values if history is too short
            let sigma = 0.02; // Daily volatility
            let mu = 0.0005;  // Daily drift
            
            if(returns.length > 5) {
                const mean = returns.reduce((a,b)=>a+b,0) / returns.length;
                mu = mean;
                const variance = returns.map(x => Math.pow(x - mean, 2)).reduce((a,b)=>a+b,0) / returns.length;
                sigma = Math.sqrt(variance);
                // Amplify sim volatility if too flat for better visual demo
                if(sigma < 0.005) sigma = 0.015;
            }

            // 2. Run Simulation
            const days = 30;
            const simulations = 1000;
            const paths = [];

            for(let i=0; i<simulations; i++) {
                let path = [stock.price];
                for(let d=0; d<days; d++) {
                    const prev = path[d];
                    const drift = (mu - (sigma*sigma)/2);
                    const shock = sigma * boxMullerRandom();
                    const price = prev * Math.exp(drift + shock);
                    path.push(price);
                }
                paths.push(path);
            }

            // 3. Analyze Results
            const finalPrices = paths.map(p => p[days]);
            finalPrices.sort((a,b) => a-b);
            
            const p10 = finalPrices[Math.floor(simulations * 0.1)];
            const p50 = finalPrices[Math.floor(simulations * 0.5)];
            const p90 = finalPrices[Math.floor(simulations * 0.9)];

            document.getElementById('mcWorst').innerText = `$${p10.toFixed(2)}`;
            document.getElementById('mcAvg').innerText = `$${p50.toFixed(2)}`;
            document.getElementById('mcBest').innerText = `$${p90.toFixed(2)}`;

            // 4. Render Chart
            renderMCChart(paths, days);
        }

        function boxMullerRandom() {
            let u = 0, v = 0;
            while(u === 0) u = Math.random(); 
            while(v === 0) v = Math.random();
            return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
        }

        function renderMCChart(paths, days) {
            const ctx = document.getElementById('mcChart').getContext('2d');
            
            // Downsample paths for performance (draw only 50 paths)
            const displayPaths = paths.slice(0, 50).map(p => ({
                data: p,
                borderColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 1,
                pointRadius: 0,
                fill: false
            }));

            // Create Labels
            const labels = Array.from({length: days+1}, (_, i) => `Day ${i}`);

            if(mcChartInstance) mcChartInstance.destroy();

            mcChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: displayPaths
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, grid: { display: false } },
                        y: { display: true, grid: { color: '#1e293b' } }
                    },
                    animation: false
                }
            });
        }

        // --- Charting ---
        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { 
                            display: true, 
                            grid: { color: '#1e293b' },
                            ticks: { color: '#64748b', font: { family: 'JetBrains Mono' } }
                        }
                    },
                    animation: false
                }
            });
        }

        function addToHistory(stock, price) {
            if(!stock.history) stock.history = [];
            const now = new Date().toLocaleTimeString();
            stock.history.push({ time: now, price: price });
            if(stock.history.length > 50) stock.history.shift(); 
        }

        function selectStock(symbol) {
            selectedStockSymbol = symbol;
            
            document.querySelectorAll('.terminal-row').forEach(r => r.classList.remove('selected'));
            const row = document.getElementById(`row-${symbol}`);
            if(row) row.classList.add('selected');
            
            const stock = stocks.find(s => s.symbol === symbol);
            if(stock) {
                document.getElementById('chartTitle').innerText = `${stock.symbol} PERFORMANCE`;
                updateChartData();
            }
        }

        function updateChartData() {
            const stock = stocks.find(s => s.symbol === selectedStockSymbol);
            if(!stock || !chartInstance) return;
            
            const priceEl = document.getElementById('chartPrice');
            priceEl.innerText = `$${stock.price.toFixed(2)}`;
            priceEl.className = `text-xl font-mono ${stock.change >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;

            const labels = stock.history.map(h => h.time);
            const data = stock.history.map(h => h.price);
            
            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = data;
            chartInstance.data.datasets[0].borderColor = stock.change >= 0 ? '#10b981' : '#f43f5e';
            chartInstance.data.datasets[0].backgroundColor = stock.change >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(244, 63, 94, 0.1)';
            
            chartInstance.update();
        }

        // --- UI Rendering ---
        function renderTable() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            document.getElementById('assetCount').innerText = stocks.length;

            if(stocks.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            } else {
                document.getElementById('emptyState').classList.add('hidden');
            }

            stocks.forEach(stock => {
                const tr = document.createElement('tr');
                tr.id = `row-${stock.symbol}`;
                tr.className = `terminal-row border-b border-slate-800/50 transition-colors ${stock.symbol === selectedStockSymbol ? 'selected' : ''}`;
                tr.onclick = () => selectStock(stock.symbol);
                
                const isPos = stock.change >= 0;
                const colorClass = isPos ? 'text-emerald-400' : 'text-rose-400';
                
                // Signal
                let signal = "HOLD";
                let signalColor = "text-slate-500";
                if(stock.changePercent > 1.0) { signal = "BUY"; signalColor = "text-emerald-400"; }
                else if(stock.changePercent < -1.0) { signal = "SELL"; signalColor = "text-rose-400"; }

                tr.innerHTML = `
                    <td class="font-bold text-white">${stock.symbol}</td>
                    <td class="font-mono text-white" id="price-${stock.symbol}">${stock.price.toFixed(2)}</td>
                    <td class="${colorClass}" id="change-${stock.symbol}">${stock.change > 0 ? '+' : ''}${stock.change.toFixed(2)}</td>
                    <td class="${colorClass}" id="pct-${stock.symbol}">${stock.changePercent.toFixed(2)}%</td>
                    <td class="text-slate-500 text-xs"><span class="text-rose-400/50">${stock.dayLow.toFixed(2)}</span> - <span class="text-emerald-400/50">${stock.dayHigh.toFixed(2)}</span></td>
                    <td class="text-slate-400" id="vol-${stock.symbol}">${formatCompact(stock.volume)}</td>
                    <td class="text-[10px] font-bold ${signalColor}">${signal}</td>
                    <td>
                        <button onclick="event.stopPropagation(); removeStock('${stock.symbol}')" class="p-1 hover:text-rose-400 text-slate-600 transition-colors"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function updateRowUI(stock, oldPrice) {
            const row = document.getElementById(`row-${stock.symbol}`);
            if(!row) return;
            
            const priceEl = document.getElementById(`price-${stock.symbol}`);
            const changeEl = document.getElementById(`change-${stock.symbol}`);
            const pctEl = document.getElementById(`pct-${stock.symbol}`);
            const volEl = document.getElementById(`vol-${stock.symbol}`);
            
            priceEl.innerText = stock.price.toFixed(2);
            changeEl.innerText = `${stock.change > 0 ? '+' : ''}${stock.change.toFixed(2)}`;
            pctEl.innerText = `${stock.changePercent.toFixed(2)}%`;
            volEl.innerText = formatCompact(stock.volume);
            
            const isPos = stock.change >= 0;
            changeEl.className = isPos ? 'text-emerald-400' : 'text-rose-400';
            pctEl.className = isPos ? 'text-emerald-400' : 'text-rose-400';

            row.classList.remove('flash-up', 'flash-down');
            void row.offsetWidth;
            if(stock.price > oldPrice) row.classList.add('flash-up');
            else if(stock.price < oldPrice) row.classList.add('flash-down');
        }

        function renderSidebar() {
            const list = document.getElementById('miniWatchlist');
            list.innerHTML = '';
            stocks.forEach(stock => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center text-xs p-2 hover:bg-slate-800 rounded cursor-pointer";
                div.onclick = () => selectStock(stock.symbol);
                div.innerHTML = `
                    <span class="font-bold text-slate-300">${stock.symbol}</span>
                    <span class="${stock.change >= 0 ? 'text-emerald-500' : 'text-rose-500'}">${stock.changePercent.toFixed(2)}%</span>
                `;
                list.appendChild(div);
            });
        }

        // --- News Feed ---
        async function fetchRealNews() {
            if(!fmpApiKey || stocks.length === 0) return;
            if(Math.random() > 0.2) return; 

            try {
                const res = await fetch(`https://financialmodelingprep.com/api/v3/stock_news?limit=3&apikey=${fmpApiKey}`);
                if(res.ok) {
                    const data = await res.json();
                    updateNewsUI(data.map(n => ({ symbol: n.symbol, title: n.title })));
                }
            } catch(e) {}
        }

        function renderNews() {
            // Initial render
        }

        function generateSimNews() {
            if(stocks.length === 0) return;
            const stock = stocks[Math.floor(Math.random() * stocks.length)];
            const move = stock.changePercent > 0 ? "jumps" : "slips";
            const headlines = [
                `${stock.symbol} ${move} on trading volume spike`,
                `Analysts adjust outlook for ${stock.symbol}`,
                `Sector volatility affects ${stock.symbol} intraday`,
                `${stock.symbol} approaches key technical level`
            ];
            const title = headlines[Math.floor(Math.random() * headlines.length)];
            addNewsItem(stock.symbol, title);
        }

        function addNewsItem(symbol, title) {
            const container = document.getElementById('newsFeed');
            const div = document.createElement('div');
            div.className = "border-l-2 border-slate-700 pl-2 py-1 animate-pulse";
            div.innerHTML = `<span class="font-bold text-emerald-500">${symbol}</span>: ${title}`;
            container.prepend(div);
            if(container.children.length > 10) container.lastChild.remove();
        }

        function updateNewsUI(newsItems) {
            newsItems.forEach(n => addNewsItem(n.symbol, n.title));
        }

        // --- AI Interaction (Robust Fallback) ---
        async function callGemini(prompt, retries = 1) {
            const keyToUse = userGeminiKey || systemApiKey;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('AI Fail');

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                // Return Local Fallback response if AI fails (Demo Mode)
                console.warn("Using Local AI Fallback");
                return localAiResponses[Math.floor(Math.random() * localAiResponses.length)];
            }
        }

        async function handleChatSubmit() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg) return;

            const history = document.getElementById('chatHistory');
            history.innerHTML += `<div class="chat-msg-user">${msg}</div>`;
            input.value = '';
            history.scrollTop = history.scrollHeight;

            const loadingId = 'load-' + Date.now();
            history.innerHTML += `<div id="${loadingId}" class="chat-msg-ai animate-pulse">Analyzing market data...</div>`;

            try {
                const context = stocks.map(s => `${s.symbol}: $${s.price.toFixed(2)} (${s.changePercent.toFixed(2)}%)`).join(', ');
                const prompt = `You are an expert financial trader AI. Current Board Data: ${context}. User asks: "${msg}". Give a short, professional, institutional-style answer. Max 50 words.`;
                
                const response = await callGemini(prompt);
                document.getElementById(loadingId).innerHTML = marked.parse(response);
            } catch(e) {
                document.getElementById(loadingId).innerText = localAiResponses[0]; 
            }
            history.scrollTop = history.scrollHeight;
        }

        // --- Helpers ---
        function addStock(symbol) {
            symbol = symbol.toUpperCase().trim();
            if(!symbol || stocks.find(s => s.symbol === symbol)) return;
            
            const base = Math.random() * 200 + 50;
            const newStock = {
                symbol, price: base, change: 0, changePercent: 0, 
                volume: 1000000, dayHigh: base, dayLow: base, history: []
            };
            for(let i=0; i<20; i++) addToHistory(newStock, base);

            stocks.push(newStock);
            renderTable();
            renderSidebar();
            selectStock(symbol);
            showToast(`Added ${symbol} to watchlist`, "success");
            saveState();
        }

        window.removeStock = function(s) {
            stocks = stocks.filter(stock => stock.symbol !== s);
            renderTable();
            renderSidebar();
            if(selectedStockSymbol === s && stocks.length > 0) selectStock(stocks[0].symbol);
            saveState();
        }

        function saveState() {
            localStorage.setItem('saved_stocks', JSON.stringify(stocks));
        }

        function saveSettings() {
            fmpApiKey = document.getElementById('fmpKeyInput').value;
            userGeminiKey = document.getElementById('geminiKeyInput').value;
            
            localStorage.setItem('fmp_api_key', fmpApiKey);
            localStorage.setItem('gemini_api_key', userGeminiKey);
            
            showToast("Configuration Saved", "success");
            togglePanel('settingsModal');
            updateModeUI();
            startEngine();
        }

        function updateModeUI() {
            const el = document.getElementById('connectionStatus');
            if(fmpApiKey) {
                el.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div> LIVE DATA`;
                el.className = "hidden md:flex text-[10px] font-bold tracking-wider text-emerald-500 bg-emerald-500/10 px-3 py-1.5 rounded border border-emerald-500/20 items-center gap-2 uppercase";
            } else {
                el.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-amber-500"></div> SIMULATION`;
                el.className = "hidden md:flex text-[10px] font-bold tracking-wider text-amber-500 bg-amber-500/10 px-3 py-1.5 rounded border border-amber-500/20 items-center gap-2 uppercase";
            }
        }

        function showToast(msg, type="info") {
            const container = document.getElementById('toastContainer');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerText = msg;
            container.appendChild(el);
            
            setTimeout(() => el.classList.add('show'), 100);
            setTimeout(() => {
                el.classList.remove('show');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        function formatCompact(num) {
            return new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(num);
        }

        function startClock() {
            setInterval(() => {
                document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            }, 1000);
        }
        
        function updateTicker() {
            const tape = document.getElementById('tickerTape');
            const html = stocks.map(s => `
                <div class="ticker-item">
                    <span class="font-bold text-slate-400">${s.symbol}</span>
                    <span class="${s.change>=0?'text-emerald-500':'text-rose-500'}">${s.price.toFixed(2)} (${s.changePercent.toFixed(2)}%)</span>
                </div>
            `).join('');
            tape.innerHTML = html + html; 
        }

        window.toggleChat = () => document.getElementById('chatPanel').classList.toggle('translate-x-full');
        window.togglePanel = (id) => {
            const el = document.getElementById(id);
            if(el.classList.contains('-translate-y-full')) el.classList.remove('-translate-y-full');
            else if(el.classList.contains('hidden')) el.classList.remove('hidden');
            else if(id === 'technicalsPanel') el.classList.add('-translate-y-full');
            else el.classList.add('hidden');
        };
        
        window.updateSimParams = () => {
            simVolatility = 0.001 + (parseInt(document.getElementById('volSlider').value) * 0.003);
            simTrend = parseFloat(document.getElementById('trendSlider').value);
            document.getElementById('volValue').innerText = document.getElementById('volSlider').value > 5 ? "HIGH" : "LOW";
        };
        window.updateSpeed = () => {
            tickSpeed = parseInt(document.getElementById('speedSlider').value);
            document.getElementById('speedValue').innerText = tickSpeed + "ms";
            startEngine();
        };

    </script>
</body>
</html>
